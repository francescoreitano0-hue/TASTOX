
/* MOTORE IRINA - ESTRATTO DA FR COLOR TURBO HD 
 * DATABASE RAL CLASSIC COMPLETO (213 COLORI)
 */

const RAL_DB = {
    "1000":[190,189,127],"1001":[194,176,120],"1002":[198,166,100],"1003":[243,187,15],"1004":[238,172,9],"1005":[200,143,0],"1006":[226,144,0],"1007":[232,140,0],"1011":[175,128,79],"1012":[221,175,39],"1013":[232,226,204],"1014":[225,204,150],"1015":[230,214,179],"1016":[241,232,55],"1017":[246,169,80],"1018":[250,202,48],"1019":[164,146,129],"1020":[160,147,110],"1021":[242,182,0],"1023":[247,181,0],"1024":[186,143,76],"1027":[163,133,0],"1028":[255,163,0],"1032":[226,163,0],"1033":[249,154,28],"1034":[235,156,82],"1037":[243,153,0],"2000":[218,110,0],"2001":[188,78,17],"2002":[182,54,28],"2003":[255,117,38],"2004":[244,70,17],"2005":[255,35,1],"2008":[255,121,34],"2009":[229,81,18],"2010":[213,77,30],"2011":[236,97,13],"2012":[231,84,67],"3000":[175,43,30],"3001":[160,33,40],"3002":[162,35,43],"3003":[141,29,44],"3004":[112,31,41],"3005":[94,32,40],"3007":[64,34,37],"3009":[112,55,49],"3011":[126,41,44],"3012":[203,141,115],"3013":[156,50,46],"3014":[212,116,121],"3015":[225,166,173],"3016":[172,64,52],"3017":[211,84,95],"3018":[209,65,82],"3020":[193,18,28],"3022":[213,109,86],"3024":[248,0,0],"3026":[254,0,0],"3027":[180,32,65],"3031":[172,50,59],"4001":[138,90,131],"4002":[147,61,80],"4003":[208,93,142],"4004":[105,25,59],"4005":[126,94,155],"4006":[153,37,114],"4007":[74,32,59],"4008":[144,70,132],"4009":[161,133,148],"4010":[195,58,113],"5000":[47,74,113],"5001":[33,68,91],"5002":[34,60,130],"5003":[35,45,75],"5004":[29,31,42],"5005":[21,72,137],"5007":[65,103,141],"5008":[47,53,62],"5009":[40,90,115],"5010":[14,70,106],"5011":[28,40,56],"5012":[39,129,187],"5013":[30,40,64],"5014":[99,118,145],"5015":[26,119,187],"5017":[6,81,140],"5018":[52,129,130],"5019":[14,93,128],"5020":[19,68,71],"5021":[7,85,84],"5022":[30,33,61],"5023":[70,96,133],"5024":[93,136,162],"6000":[49,106,80],"6001":[49,110,52],"6002":[45,87,44],"6003":[77,84,59],"6004":[26,59,53],"6005":[22,58,44],"6006":[62,61,50],"6007":[39,49,35],"6008":[49,48,35],"6009":[34,47,38],"6010":[69,122,51],"6011":[102,124,84],"6012":[46,59,56],"6013":[118,114,74],"6014":[68,67,55],"6015":[55,58,48],"6016":[0,102,70],"6017":[77,133,66],"6018":[87,166,57],"6019":[189,225,172],"6020":[55,65,46],"6021":[135,161,128],"6022":[37,36,29],"6024":[0,131,81],"6025":[86,118,51],"6026":[0,92,84],"6027":[129,192,187],"6028":[45,85,70],"6029":[0,114,45],"6032":[15,141,88],"6033":[65,137,126],"6034":[127,177,177],"7000":[122,136,142],"7001":[138,149,151],"7002":[126,123,82],"7003":[122,123,109],"7004":[150,153,146],"7005":[100,107,99],"7006":[109,101,82],"7008":[106,95,49],"7009":[93,97,80],"7010":[86,90,92],"7011":[78,86,88],"7012":[87,93,87],"7013":[81,78,62],"7015":[75,77,82],"7016":[56,62,66],"7021":[47,50,52],"7022":[75,77,70],"7023":[126,130,122],"7024":[69,73,78],"7026":[47,54,61],"7030":[147,147,136],"7031":[91,104,112],"7032":[184,183,153],"7033":[125,132,113],"7034":[143,139,102],"7035":[215,215,215],"7036":[148,149,161],"7037":[120,123,128],"7038":[181,184,177],"7039":[108,105,96],"7040":[157,163,166],"7042":[143,150,150],"7043":[78,84,82],"7044":[185,185,168],"7045":[144,144,144],"7046":[130,137,143],"7047":[208,208,208],"8000":[130,108,52],"8001":[149,95,32],"8002":[108,59,42],"8003":[115,66,34],"8004":[142,64,42],"8007":[89,53,31],"8008":[111,79,40],"8011":[91,58,36],"8012":[89,35,33],"8014":[56,44,30],"8015":[73,31,26],"8016":[60,34,25],"8017":[45,28,18],"8019":[59,51,50],"8022":[26,22,21],"8023":[166,94,46],"8024":[121,85,61],"8025":[117,92,72],"8028":[78,59,49],"9001":[241,235,225],"9002":[231,235,218],"9003":[244,244,244],"9004":[40,40,40],"9005":[10,10,10],"9006":[165,165,165],"9007":[143,143,143],"9010":[255,255,255],"9011":[28,28,28],"9016":[246,246,246],"9017":[30,30,30],"9018":[215,215,215]
};

// AGGIORNAMENTO PROFILI (Pareti Lisce/Ruvide)
const PROFILI = {
    "liscio": 45,
    "standard": 65,
    "ruvido": 95
};
let tolleranzaAttuale = 65;

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', {willReadFrequently: true});
const z = document.getElementById('z'), view = document.getElementById('viewport');
let ori = null, hist = [], mode = 'f', curF = [255,255,255], curC = [255,255,255];

// FUNZIONE CARICAMENTO (Identica alla tua originale)
function load(e) {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = (ev) => {
        const i = new Image();
        i.onload = () => {
            canvas.width = i.width; canvas.height = i.height;
            ctx.drawImage(i, 0, 0);
            ori = ctx.getImageData(0, 0, i.width, i.height);
            hist = [ctx.getImageData(0, 0, i.width, i.height)];
            applyZ();
        };
        i.src = ev.target.result;
    };
    r.readAsDataURL(f);
}

document.getElementById('u').onchange = load;
document.getElementById('c').onchange = load;

function applyZ() { canvas.style.transform = `scale(${z.value})`; }
z.oninput = applyZ;

function setM(m) {
    mode = m;
    document.getElementById('bmf').className = m === 'f' ? 'm-btn active' : 'm-btn';
    document.getElementById('bmc').className = m === 'c' ? 'm-btn active' : 'm-btn';
}

// NUOVA FUNZIONE SET PROFILO PARETE
function setP(p) {
    tolleranzaAttuale = PROFILI[p];
    document.getElementById('p-liscio').className = p === 'liscio' ? 'm-btn active' : 'm-btn';
    document.getElementById('p-std').className = p === 'standard' ? 'm-btn active' : 'm-btn';
    document.getElementById('p-ruvido').className = p === 'ruvido' ? 'm-btn active' : 'm-btn';
}

function findRal(q) {
    const res = document.getElementById('ralRes');
    res.innerHTML = '';
    if (q.length < 2) return;
    Object.keys(RAL_DB).forEach(k => {
        if (k.includes(q)) {
            const d = document.createElement('div');
            d.className = 'ral-item';
            d.style.background = `rgb(${RAL_DB[k].join(',')})`;
            d.onclick = () => {
                if (mode === 'f') curF = RAL_DB[k]; else curC = RAL_DB[k];
                document.getElementById('ralSearch').value = 'RAL ' + k;
                res.innerHTML = '';
            };
            res.appendChild(d);
        }
    });
}

// MOTORE COLORAZIONE (Identico al tuo, con aggiunta tolleranza variabile)
canvas.onclick = (e) => {
    if (!ori) return;
    const s = z.value;
    const rect = canvas.getBoundingClientRect();
    const startX = Math.round((e.clientX - rect.left) / s);
    const startY = Math.round((e.clientY - rect.top) / s);
    const color = mode === 'f' ? curF : curC;

    const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = img.data, w = canvas.width, h = canvas.height;
    const pos = (startY * w + startX) * 4;
    const targetR = data[pos], targetG = data[pos+1], targetB = data[pos+2];

    const stack = [[startX, startY]];
    const visited = new Uint8Array(w * h);
    
    // USA LA TOLLERANZA DINAMICA DEI PROFILI
    const tol = tolleranzaAttuale;

    function match(p) {
        return Math.abs(data[p] - targetR) < tol && Math.abs(data[p+1] - targetG) < tol && Math.abs(data[p+2] - targetB) < tol;
    }

    while (stack.length) {
        let [x, y] = stack.pop();
        let p = (y * w + x) * 4;
        while (y >= 0 && match(p)) { y--; p -= w * 4; }
        p += w * 4; y++;
        let reachLeft = false, reachRight = false;

        while (y < h && match(p)) {
            // Formula Lum Blindata per realismo ombre
            const lum = (0.299 * ori.data[p] + 0.587 * ori.data[p+1] + 0.114 * ori.data[p+2]) / 255;
            data[p] = color[0] * lum; data[p+1] = color[1] * lum; data[p+2] = color[2] * lum;
            visited[y * w + x] = 1;

            if (x > 0) {
                if (match(p - 4) && !visited[y * w + (x - 1)]) {
                    if (!reachLeft) { stack.push([x - 1, y]); reachLeft = true; }
                } else if (reachLeft) { reachLeft = false; }
            }
            if (x < w - 1) {
                if (match(p + 4) && !visited[y * w + (x + 1)]) {
                    if (!reachRight) { stack.push([x + 1, y]); reachRight = true; }
                } else if (reachRight) { reachRight = false; }
            }
            y++; p += w * 4;
        }
    }
    ctx.putImageData(img, 0, 0);
    hist.push(ctx.getImageData(0, 0, w, h));
};

function undo() {
    if (hist.length > 1) {
        hist.pop();
        ctx.putImageData(hist[hist.length - 1], 0, 0);
    }
}
