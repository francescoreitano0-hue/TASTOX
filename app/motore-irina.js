/* MOTORE IRINA - ESTRATTO DA FR COLOR TURBO HD 
 * DATABASE RAL CLASSIC COMPLETO (213 COLORI)
 */

const RAL_DB = {
    "1000":[190,189,127],"1001":[194,176,120],"1002":[198,166,100],"1003":[243,187,15],"1004":[238,172,9],"1005":[200,143,0],"1006":[226,144,0],"1007":[232,140,0],"1011":[175,128,79],"1012":[221,175,39],"1013":[232,226,204],"1014":[225,204,150],"1015":[230,214,179],"1016":[241,232,55],"1017":[246,169,80],"1018":[250,202,48],"1019":[164,146,129],"1020":[160,147,110],"1021":[242,182,0],"1023":[247,181,0],"1024":[186,143,76],"1026":[255,255,0],"1027":[167,127,14],"1028":[255,155,0],"1032":[226,163,0],"1033":[249,154,28],"1034":[239,151,81],"1035":[144,123,101],"1036":[112,83,53],"1037":[243,153,0],"2000":[237,118,14],"2001":[196,57,38],"2002":[212,33,21],"2003":[255,117,20],"2004":[244,70,17],"2005":[255,35,1],"2007":[255,164,32],"2008":[237,107,33],"2009":[222,83,7],"2010":[216,75,32],"2011":[236,124,38],"2012":[231,91,78],"2013":[141,51,36],"3000":[175,43,30],"3001":[165,32,25],"3002":[155,17,30],"3003":[142,18,13],"3004":[112,28,28],"3005":[89,31,34],"3007":[65,34,39],"3009":[109,48,40],"3011":[121,36,35],"3012":[203,115,117],"3013":[161,39,31],"3014":[217,110,120],"3015":[225,173,186],"3016":[179,56,49],"3017":[211,84,96],"3018":[213,48,72],"3020":[193,18,31],"3022":[217,80,67],"3024":[248,0,0],"3026":[254,0,0],"3027":[183,30,66],"3028":[203,50,52],"3031":[172,32,54],"3032":[114,20,34],"3033":[180,33,44],"4001":[144,92,130],"4002":[146,43,62],"4003":[222,76,138],"4004":[110,38,63],"4005":[108,70,117],"4006":[160,52,114],"4007":[74,34,57],"4008":[146,78,125],"4009":[164,131,150],"4010":[193,14,99],"4011":[134,115,161],"4012":[108,104,129],"5000":[53,91,123],"5001":[31,71,94],"5002":[32,32,96],"5003":[31,41,64],"5004":[30,30,38],"5005":[30,71,129],"5007":[59,105,140],"5008":[38,45,53],"5009":[46,90,113],"5010":[14,67,121],"5011":[27,35,46],"5012":[52,129,184],"5013":[35,43,72],"5014":[96,111,140],"5015":[34,113,179],"5017":[6,55,123],"5018":[5,139,140],"5019":[27,85,131],"5020":[1,72,78],"5021":[7,114,124],"5022":[37,40,80],"5023":[77,103,134],"5024":[93,155,177],"5025":[45,106,106],"5026":[16,44,84],"6000":[50,116,96],"6001":[40,114,51],"6002":[45,87,44],"6003":[77,83,60],"6004":[5,68,67],"6005":[14,67,49],"6006":[53,54,46],"6007":[52,59,41],"6008":[5,53,37],"6009":[33,47,38],"6010":[77,123,53],"6011":[108,124,89],"6012":[40,52,49],"6013":[119,115,92],"6014":[71,65,53],"6015":[59,60,54],"6016":[1,105,74],"6017":[77,142,68],"6018":[87,166,57],"6019":[189,221,181],"6020":[46,58,35],"6021":[137,172,139],"6022":[37,34,27],"6024":[0,131,81],"6025":[93,122,46],"6026":[1,93,82],"6027":[129,199,190],"6028":[44,84,69],"6029":[0,111,59],"6032":[15,125,81],"6033":[70,135,127],"6034":[123,182,189],"6035":[28,84,45],"6036":[7,83,71],"6037":[0,140,52],"6038":[0,187,45],"7000":[120,129,133],"7001":[143,153,159],"7002":[129,126,108],"7003":[122,123,105],"7004":[150,153,154],"7005":[107,110,107],"7006":[117,106,94],"7008":[115,95,56],"7009":[85,89,82],"7010":[87,93,84],"7011":[83,89,93],"7012":[89,97,101],"7013":[85,82,71],"7015":[81,82,88],"7016":[56,62,66],"7021":[47,50,52],"7022":[51,52,50],"7023":[129,132,121],"7024":[71,74,80],"7026":[47,53,59],"7030":[147,144,138],"7031":[93,107,113],"7032":[184,183,168],"7033":[125,132,121],"7034":[143,139,121],"7035":[215,215,215],"7036":[153,147,144],"7037":[122,123,122],"7038":[195,195,195],"7039":[107,105,100],"7040":[152,158,161],"7042":[141,146,149],"7043":[78,82,82],"7044":[202,199,191],"7045":[144,149,154],"7046":[130,136,142],"7047":[208,208,208],"7048":[136,133,124],"8000":[136,113,66],"8001":[153,102,46],"8002":[115,70,54],"8003":[122,77,46],"8004":[141,73,49],"8007":[110,74,48],"8008":[112,79,44],"8011":[91,58,41],"8012":[103,49,40],"8014":[73,56,41],"8015":[99,50,40],"8016":[76,47,39],"8017":[69,50,45],"8019":[61,54,53],"8022":[26,23,24],"8023":[164,87,41],"8024":[121,80,63],"8025":[117,88,71],"8028":[78,59,42],"8029":[118,60,44],"9001":[241,235,217],"9002":[222,223,216],"9003":[244,248,244],"9004":[40,40,40],"9005":[10,10,13],"9006":[165,165,165],"9007":[143,143,143],"9010":[241,236,225],"9011":[28,31,33],"9016":[246,250,250],"9017":[30,30,33],"9018":[215,219,215],"9022":[156,156,156],"9023":[130,133,133]
}; 

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', {willReadFrequently: true});
const z = document.getElementById('z');
const view = document.getElementById('viewport');
let ori = null, hist = [], mode = 'f';
let curF = [120, 129, 133], curC = [232, 226, 204];

const load = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
            canvas.width = img.width; canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            ori = ctx.getImageData(0,0,canvas.width,canvas.height);
            hist = [ctx.getImageData(0,0,canvas.width,canvas.height)];
            z.value = 1; applyZ();
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
};

document.getElementById('c').onchange = load;
document.getElementById('u').onchange = load;

z.oninput = applyZ;
function applyZ() {
    const s = z.value;
    canvas.style.width = (canvas.width * s) + "px";
    canvas.style.height = (canvas.height * s) + "px";
}

function setM(m) { 
    mode = m; 
    document.getElementById('bmf').classList.toggle('active', m === 'f'); 
    document.getElementById('bmc').classList.toggle('active', m === 'c'); 
}

function findRal(v) { 
    if(RAL_DB[v]) { 
        const c = RAL_DB[v]; 
        if(mode==='f') curF=c; else curC=c; 
        document.getElementById('prev-col').style.background = `rgb(${c[0]},${c[1]},${c[2]})`; 
        document.getElementById('ral-name').innerText = `Selezionato: RAL ${v}`; 
    } 
}

// MOTORE TURBO HD (SCANLINE FILL) [cite: 2025-12-27]
canvas.onclick = (e) => {
    if(!ori) return;
    const s = z.value;
    const startX = Math.round(e.offsetX / s);
    const startY = Math.round(e.offsetY / s);
    const color = mode === 'f' ? curF : curC;
    
    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    const data = img.data, w = canvas.width, h = canvas.height;
    const pos = (startY * w + startX) * 4;
    const targetR = data[pos], targetG = data[pos+1], targetB = data[pos+2];
    
    const stack = [[startX, startY]];
    const visited = new Uint8Array(w * h);
    const tolerance = 65;

    while(stack.length) {
        let [x, y] = stack.pop();
        let p = (y * w + x) * 4;

        while (y >= 0 && match(p)) { y--; p -= w * 4; }
        p += w * 4; y++;
        let reachLeft = false, reachRight = false;

        while (y < h && match(p)) {
            // Formula Lum Blindata per realismo ombre [cite: 2025-12-27]
            const lum = (0.299 * ori.data[p] + 0.587 * ori.data[p+1] + 0.114 * ori.data[p+2]) / 255;
            data[p] = color[0] * lum; data[p+1] = color[1] * lum; data[p+2] = color[2] * lum;
            visited[y * w + x] = 1;

            if (x > 0) {
                if (match(p - 4) && !visited[y * w + (x - 1)]) {
                    if (!reachLeft) { stack.push([x - 1, y]); reachLeft = true; }
                } else if (reachLeft) { reachLeft = false; }
            }
            if (x < w - 1) {
                if (match(p + 4) && !visited[y * w + (x + 1)]) {
                    if (!reachRight) { stack.push([x + 1, y]); reachRight = true; }
                } else if (reachRight) { reachRight = false; }
            }
            y++; p += w * 4;
        }
    }

    function match(p) {
        return Math.abs(data[p] - targetR) + Math.abs(data[p+1] - targetG) + Math.abs(data[p+2] - targetB) < tolerance;
    }

    ctx.putImageData(img, 0, 0);
    if(hist.length > 5) hist.shift();
    hist.push(ctx.getImageData(0,0,canvas.width,canvas.height));
};

function undo() { if(hist.length > 1) { hist.pop(); ctx.putImageData(hist[hist.length-1],0,0); } }
function save() { const l = document.createElement('a'); l.download='progetto.png'; l.href=canvas.toDataURL(); l.click(); }
